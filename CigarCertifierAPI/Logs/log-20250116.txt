2025-01-16 14:28:17.258 +01:00 [INF] Start installing Hangfire SQL objects...
2025-01-16 14:28:18.210 +01:00 [INF] Hangfire SQL objects installed.
2025-01-16 14:28:18.696 +01:00 [ERR] An error occurred while reading the key ring.
System.UnauthorizedAccessException: Access to the path '/root/.aspnet/DataProtection-Keys' is denied.
 ---> System.IO.IOException: Permission denied
   --- End of inner exception stack trace ---
   at System.IO.FileSystem.CreateDirectory(String fullPath, UnixFileMode unixCreateMode)
   at System.IO.DirectoryInfo.Create()
   at Microsoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository.GetAllElementsCore()+MoveNext()
   at System.Collections.Generic.List`1..ctor(IEnumerable`1 collection)
   at System.Linq.Enumerable.ToList[TSource](IEnumerable`1 source)
   at Microsoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository.GetAllElements()
   at Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager.GetAllKeys()
   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingProvider.CreateCacheableKeyRingCore(DateTimeOffset now, IKey keyJustAdded)
   at System.Threading.Tasks.Task`1.InnerInvoke()
   at System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread threadPoolThread, ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread threadPoolThread, ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingProvider.GetKeyRingFromCompletedTaskUnsynchronized(Task`1 task, DateTime utcNow)
2025-01-16 14:28:18.724 +01:00 [INF] Key ring failed to load during application startup.
System.UnauthorizedAccessException: Access to the path '/root/.aspnet/DataProtection-Keys' is denied.
 ---> System.IO.IOException: Permission denied
   --- End of inner exception stack trace ---
   at System.IO.FileSystem.CreateDirectory(String fullPath, UnixFileMode unixCreateMode)
   at System.IO.DirectoryInfo.Create()
   at Microsoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository.GetAllElementsCore()+MoveNext()
   at System.Collections.Generic.List`1..ctor(IEnumerable`1 collection)
   at System.Linq.Enumerable.ToList[TSource](IEnumerable`1 source)
   at Microsoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository.GetAllElements()
   at Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager.GetAllKeys()
   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingProvider.CreateCacheableKeyRingCore(DateTimeOffset now, IKey keyJustAdded)
   at System.Threading.Tasks.Task`1.InnerInvoke()
   at System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread threadPoolThread, ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread threadPoolThread, ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingProvider.GetKeyRingFromCompletedTaskUnsynchronized(Task`1 task, DateTime utcNow)
   at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingProvider.GetCurrentKeyRingCoreNew(DateTime utcNow, Boolean forceRefresh)
   at Microsoft.AspNetCore.DataProtection.Internal.DataProtectionHostedService.StartAsync(CancellationToken token)
2025-01-16 14:28:18.735 +01:00 [WRN] Overriding HTTP_PORTS '8080' and HTTPS_PORTS ''. Binding to values defined by URLS instead 'http://*:5000;'.
2025-01-16 14:28:18.805 +01:00 [INF] Now listening on: http://[::]:5000
2025-01-16 14:28:18.811 +01:00 [INF] Starting Hangfire Server using job storage: 'SQL Server: 172.26.211.97,1433@CigarCertifierDB'
2025-01-16 14:28:18.812 +01:00 [INF] Using the following options for SQL Server job storage: Queue poll interval: 00:00:00.
2025-01-16 14:28:18.813 +01:00 [INF] Using the following options for Hangfire Server:
    Worker count: 20
    Listening queues: 'default'
    Shutdown timeout: 00:00:15
    Schedule polling interval: 00:00:15
2025-01-16 14:28:18.828 +01:00 [INF] Application started. Press Ctrl+C to shut down.
2025-01-16 14:28:18.829 +01:00 [INF] Hosting environment: Production
2025-01-16 14:28:18.829 +01:00 [INF] Content root path: /mnt/c/Users/ladfr/source/repos/cigarcert/CigarCertifierAPI
2025-01-16 14:28:18.857 +01:00 [INF] Server upp99:56385:98d304c6 successfully announced in 20.6296 ms
2025-01-16 14:28:18.863 +01:00 [INF] Server upp99:56385:98d304c6 is starting the registered dispatchers: ServerWatchdog, ServerJobCancellationWatcher, ExpirationManager, CountersAggregator, SqlServerHeartbeatProcess, Worker, DelayedJobScheduler, RecurringJobScheduler...
2025-01-16 14:28:18.893 +01:00 [INF] 1 servers were removed due to timeout
2025-01-16 14:28:19.061 +01:00 [INF] Server upp99:56385:98d304c6 all the dispatchers started
2025-01-16 14:28:20.238 +01:00 [INF] Executed DbCommand (16ms) [Parameters=[@__now_0='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SELECT [b].[Id], [b].[ExpiresAt], [b].[Token]
FROM [BlacklistedTokens] AS [b]
WHERE [b].[ExpiresAt] <= @__now_0
2025-01-16 14:28:20.263 +01:00 [INF] Executed DbCommand (5ms) [Parameters=[@__now_0='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SELECT [a].[Id], [a].[ExpiresAt], [a].[Token], [a].[UserId]
FROM [ActiveTokens] AS [a]
WHERE [a].[ExpiresAt] <= @__now_0
2025-01-16 14:31:27.749 +01:00 [INF] Request starting HTTP/1.1 POST http://localhost:5000/api/auth/login - application/json 112
2025-01-16 14:31:27.753 +01:00 [WRN] Failed to determine the https port for redirect.
2025-01-16 14:31:27.919 +01:00 [INF] Executing endpoint 'CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI)'
2025-01-16 14:31:27.934 +01:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(CigarCertifierAPI.Dto.LoginDto) on controller CigarCertifierAPI.Controllers.AuthController (CigarCertifierAPI).
2025-01-16 14:31:27.986 +01:00 [INF] Executing BadRequestObjectResult, writing value of type 'Microsoft.AspNetCore.Mvc.ValidationProblemDetails'.
2025-01-16 14:31:28.013 +01:00 [INF] Executed action CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI) in 76.9962ms
2025-01-16 14:31:28.015 +01:00 [INF] Executed endpoint 'CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI)'
2025-01-16 14:31:28.018 +01:00 [INF] HTTP POST /api/auth/login responded 400 in 263.2366 ms
2025-01-16 14:31:28.021 +01:00 [INF] Request finished HTTP/1.1 POST http://localhost:5000/api/auth/login - 400 null application/problem+json; charset=utf-8 272.0987ms
2025-01-16 14:34:18.041 +01:00 [INF] Request starting HTTP/1.1 POST http://localhost:5000/api/auth/login - application/json 96
2025-01-16 14:34:18.051 +01:00 [INF] Executing endpoint 'CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI)'
2025-01-16 14:34:18.052 +01:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(CigarCertifierAPI.Dto.LoginDto) on controller CigarCertifierAPI.Controllers.AuthController (CigarCertifierAPI).
2025-01-16 14:34:18.079 +01:00 [INF] Attempting to log in user: testuser
2025-01-16 14:34:18.109 +01:00 [INF] Executed DbCommand (4ms) [Parameters=[@__model_Username_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[CreatedAt], [u].[Email], [u].[IsTwoFactorEnabled], [u].[PasswordHash], [u].[PasswordResetToken], [u].[PasswordResetTokenExpiry], [u].[TwoFactorSecret], [u].[Username]
FROM [Users] AS [u]
WHERE [u].[Username] = @__model_Username_0
2025-01-16 14:34:18.329 +01:00 [WRN] Login failed for user testuser. Invalid credentials.
2025-01-16 14:34:18.331 +01:00 [INF] Executing UnauthorizedObjectResult, writing value of type 'CigarCertifierAPI.Dto.ErrorResponseDto'.
2025-01-16 14:34:18.335 +01:00 [INF] Executed action CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI) in 281.9679ms
2025-01-16 14:34:18.336 +01:00 [INF] Executed endpoint 'CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI)'
2025-01-16 14:34:18.337 +01:00 [INF] HTTP POST /api/auth/login responded 401 in 295.3505 ms
2025-01-16 14:34:18.339 +01:00 [INF] Request finished HTTP/1.1 POST http://localhost:5000/api/auth/login - 401 null application/json; charset=utf-8 297.8131ms
2025-01-16 14:34:45.068 +01:00 [INF] Request starting HTTP/1.1 POST http://localhost:5000/api/auth/login - application/json 98
2025-01-16 14:34:45.073 +01:00 [INF] Executing endpoint 'CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI)'
2025-01-16 14:34:45.074 +01:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(CigarCertifierAPI.Dto.LoginDto) on controller CigarCertifierAPI.Controllers.AuthController (CigarCertifierAPI).
2025-01-16 14:34:45.076 +01:00 [INF] Attempting to log in user: testuser3
2025-01-16 14:34:45.122 +01:00 [INF] Executed DbCommand (1ms) [Parameters=[@__model_Username_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[CreatedAt], [u].[Email], [u].[IsTwoFactorEnabled], [u].[PasswordHash], [u].[PasswordResetToken], [u].[PasswordResetTokenExpiry], [u].[TwoFactorSecret], [u].[Username]
FROM [Users] AS [u]
WHERE [u].[Username] = @__model_Username_0
2025-01-16 14:34:45.302 +01:00 [INF] Executed DbCommand (4ms) [Parameters=[@__user_Id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[Id], [a].[ExpiresAt], [a].[Token], [a].[UserId]
FROM [ActiveTokens] AS [a]
WHERE [a].[UserId] = @__user_Id_0 AND [a].[ExpiresAt] > GETUTCDATE()
2025-01-16 14:34:45.410 +01:00 [INF] Executed DbCommand (11ms) [Parameters=[@p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [ActiveTokens] ([ExpiresAt], [Token], [UserId])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2);
2025-01-16 14:34:45.424 +01:00 [INF] User testuser3 logged in successfully.
2025-01-16 14:34:45.425 +01:00 [INF] Executing OkObjectResult, writing value of type 'CigarCertifierAPI.Dto.TokenResponseDto'.
2025-01-16 14:34:45.430 +01:00 [INF] Executed action CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI) in 354.3786ms
2025-01-16 14:34:45.430 +01:00 [INF] Executed endpoint 'CigarCertifierAPI.Controllers.AuthController.Login (CigarCertifierAPI)'
2025-01-16 14:34:45.431 +01:00 [INF] HTTP POST /api/auth/login responded 200 in 359.7746 ms
2025-01-16 14:34:45.431 +01:00 [INF] Request finished HTTP/1.1 POST http://localhost:5000/api/auth/login - 200 null application/json; charset=utf-8 363.2196ms
